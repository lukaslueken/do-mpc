copy from do_mpc examples